name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      any_changed: ${{ steps.set-services.outputs.any_changed }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect changed services
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          api-gateway:
            - 'src/api-gateway/**'
          auth:
            - 'src/auth/**'
          chat:
            - 'src/chat/**'
          matchmaking:
            - 'src/matchmaking/**'
          user-management:
            - 'src/user-management/**'
          
          common:
            - 'package.json'
            - 'package-lock.json'
            - '.github/workflows/**'

    - name: Set service matrix
      id: set-services
      run: |
        services=()

        # If common files changed, run all services
        if [ "${{ steps.filter.outputs.common }}" == "true" ]; then
          services=("api-gateway" "auth" "frontend" "matchmaking")
        else
          # Otherwise, only add changed services
          if [ "${{ steps.filter.outputs.api-gateway }}" == "true" ]; then
            services+=("api-gateway")
          fi
          if [ "${{ steps.filter.outputs.auth }}" == "true" ]; then
            services+=("auth")
          fi
          if [ "${{ steps.filter.outputs.matchmaking }}" == "true" ]; then
            services+=("matchmaking")
          fi
        fi

        # Convert to JSON array
        if [ ${#services[@]} -eq 0 ]; then
          echo "services=[]" >> $GITHUB_OUTPUT
          echo "any_changed=false" >> $GITHUB_OUTPUT
        else
          json=$(printf '%s\n' "${services[@]}" | jq -R . | jq -s -c .)
          echo "services=$json" >> $GITHUB_OUTPUT
          echo "any_changed=true" >> $GITHUB_OUTPUT
        fi

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

  test:
    name: Test (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.any_changed == 'true' }}

    strategy:
      matrix:
        node-version: [20.x]
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: src/${{ matrix.service }}/package-lock.json

    - name: Install dependencies
      run: npm ci
      working-directory: src/${{ matrix.service }}

    - name: Generate Prisma Client
      if: matrix.service == 'auth' || matrix.service == 'matchmaking' || matrix.service == 'user-management'
      run: npx prisma generate
      working-directory: src/${{ matrix.service }}

    - name: Run tests
      run: npm run test:run
      working-directory: src/${{ matrix.service }}

    - name: Run tests with coverage
      run: npm run test:coverage
      working-directory: src/${{ matrix.service }}

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: src/${{ matrix.service }}/coverage/lcov.info
        flags: ${{ matrix.service }}
        name: codecov-${{ matrix.service }}
        fail_ci_if_error: false

  build:
    name: Build (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: ${{ always() && needs.lint.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped') }}

    strategy:
      matrix:
        service: [api-gateway, auth, frontend, matchmaking]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: src/${{ matrix.service }}/package-lock.json

    - name: Install dependencies
      run: npm ci
      working-directory: src/${{ matrix.service }}

    - name: Generate Prisma Client
      if: matrix.service == 'auth' || matrix.service == 'matchmaking' || matrix.service == 'user-management'
      run: npx prisma generate
      working-directory: src/${{ matrix.service }}

    - name: Build project
      run: npm run build
      working-directory: src/${{ matrix.service }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.service }}
        path: src/${{ matrix.service }}/dist/
        retention-days: 30

  security-scan:
    name: Security Scan (${{ matrix.service }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [api-gateway, auth, frontend, matchmaking]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: src/${{ matrix.service }}/package-lock.json

    - name: Install dependencies
      run: npm ci
      working-directory: src/${{ matrix.service }}

    - name: Run security audit
      run: npm audit --audit-level moderate
      working-directory: src/${{ matrix.service }}
      continue-on-error: true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: dist/
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your staging deployment commands here
        # Example: docker build, kubectl apply, etc.

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build, security-scan]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: dist/
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Add your production deployment commands here
        # Example: docker build, kubectl apply, etc.


input {
  # Receive logs from Filebeat
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/usr/share/logstash/certs/logstash/logstash.crt"
    ssl_key => "/usr/share/logstash/certs/logstash/logstash.key"
    ssl_certificate_authorities => ["/usr/share/logstash/certs/ca/ca.crt"]
    # TODO: Implement proper client certificates - currently using optional for flexibility
    ssl_client_authentication => "optional"
  }
}

filter {
  # Handle Filebeat's service field if it exists as an object
  if [service][type] {
    mutate {
      add_field => { "service_name" => "%{[service][type]}" }
    }
  }

  # Extract service name from Docker container name
  # Filebeat adds container.name (e.g., "transcendence-api-gateway-1")
  if [container][name] and ![service_name] {
    grok {
      match => { "[container][name]" => "^transcendence-(?<service_name>[a-zA-Z0-9_-]+)-\d+$" }
    }
  }

  # Fallback: use hostname if service not extracted
  if ![service_name] and [hostname] {
    mutate {
      add_field => { "service_name" => "%{hostname}" }
    }
  }

  # Parse JSON log message if it exists
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "log_data"
    }

    # Copy parsed fields to root level
    if [log_data][level] {
      mutate {
        add_field => { "level" => "%{[log_data][level]}" }
      }
    }
    if [log_data][time] {
      mutate {
        add_field => { "time" => "%{[log_data][time]}" }
      }
    }
  }

  # Convert timestamp
  if [time] {
    date {
      match => [ "time", "UNIX_MS" ]
      target => "@timestamp"
    }
    mutate {
      remove_field => [ "time" ]
    }
  }

  # Add severity level based on Pino level
  if [level] {
    if [level] >= 50 {
      mutate {
        add_field => { "severity" => "error" }
      }
    } else if [level] >= 40 {
      mutate {
        add_field => { "severity" => "warn" }
      }
    } else if [level] >= 30 {
      mutate {
        add_field => { "severity" => "info" }
      }
    } else {
      mutate {
        add_field => { "severity" => "debug" }
      }
    }
  }

  # Determine index name based on service
  if [service_name] and [service_name] != "" {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "logs-%{service_name}-%{+YYYY.MM.dd}"
      }
    }
  } else {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "logs-unknown-%{+YYYY.MM.dd}"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTIC_HOSTS}"]
    user => "${ELASTIC_USER}"
    password => "${ELASTIC_PASSWORD}"
    ssl_certificate_authorities => ["/usr/share/logstash/certs/ca/ca.crt"]

    index => "%{[@metadata][index_name]}"
    action => "create"
  }

  # Debug output - see what Logstash receives and sends
  # Enable only when LOGSTASH_DEBUG is set to "true"
  if "${LOGSTASH_DEBUG}" == "true" {
    stdout {
      codec => rubydebug
    }
  }
}
